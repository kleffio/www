---

name: Java CI with Gradle

"on":
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  deployment_service_test:
    runs-on: "ubuntu-22.04"
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      - name: Cache Gradle packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: >-
            ${{ runner.os }}-gradle-deployment-${{
            hashFiles('**/deployment-service/*.gradle*',
            '**/deployment-service/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-deployment-
            ${{ runner.os }}-gradle-
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
      - name: Make gradlew executable
        run: chmod +x ./gradlew
        working-directory: ./deployment-service
      - name: Build and Test
        run: ./gradlew clean build jacocoTestReport --daemon
        working-directory: ./deployment-service
      - name: Verify coverage threshold
        run: ./gradlew jacocoTestCoverageVerification --daemon
        working-directory: ./deployment-service
      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports-deployment-service
          path: ./deployment-service/build/reports/jacoco/test/html/
          retention-days: 30
        if: always()

  project_management_service_test:
    runs-on: "ubuntu-22.04"
    timeout-minutes: 15
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: 17
      - name: Cache Gradle packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: >-
            ${{ runner.os }}-gradle-project-mgmt-${{
            hashFiles('**/project-management-service/*.gradle*',
            '**/project-management-service/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-project-mgmt-
            ${{ runner.os }}-gradle-
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
      - name: Make gradlew executable
        run: chmod +x ./gradlew
        working-directory: ./project-management-service
      - name: Build and Test
        run: ./gradlew clean build jacocoTestReport --daemon
        working-directory: ./project-management-service
      - name: Verify coverage threshold
        run: ./gradlew jacocoTestCoverageVerification --daemon
        working-directory: ./project-management-service
      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports-project-management-service
          path: ./project-management-service/build/reports/jacoco/test/html/
          retention-days: 30
        if: always()

  coverage-summary:
    runs-on: "ubuntu-22.04"
    needs: [deployment_service_test]
    if: >-
      always() && (github.event_name == 'pull_request' ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main'))
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4
      - name: Download all coverage reports
        uses: actions/download-artifact@v4
        with:
          path: coverage-reports
      - name: Generate coverage summary
        run: |
          echo "## Code Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Coverage reports generated for updated microservices." \
            >> $GITHUB_STEP_SUMMARY
          echo "### Actual Coverage Results" >> $GITHUB_STEP_SUMMARY

          for report_dir in coverage-reports/*/; do
            if [ -d "$report_dir" ]; then
              service_name=$(basename "$report_dir")
              main_index="$report_dir/index.html"
              if [ -f "$main_index" ]; then
                # Attempt to extract percentage from Jacoco HTML
                coverage=$(grep -o 'class="ctr2">[0-9]*%' "$main_index" | \
                  head -1 | grep -o '[0-9]*%')
                if [ -z "$coverage" ]; then
                  coverage=$(grep -o '[0-9]*%' "$main_index" | head -1)
                fi
                echo "- $service_name: $coverage" >> $GITHUB_STEP_SUMMARY
              else
                echo "- $service_name: No coverage report found" \
                  >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done
